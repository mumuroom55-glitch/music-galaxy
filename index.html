<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>Interstellar Quantum Player - Luminous Edition</title>
    <style>
        /* èƒŒæ™¯è°ƒå¾—æ›´æ·±ï¼Œå¯¹æ¯”åº¦æ›´é«˜ */
        body { margin: 0; overflow: hidden; background-color: #020204; font-family: 'Segoe UI', sans-serif; user-select: none; }
        
        /* å¯åŠ¨é®ç½© */
        #overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; justify-content: center; align-items: center;
            background: radial-gradient(circle, rgba(0,0,0,0.4) 0%, rgba(2,2,5,0.98) 100%);
            z-index: 10; flex-direction: column; transition: opacity 1s;
        }
        h1 { color: #fff; font-weight: 300; letter-spacing: 8px; text-shadow: 0 0 40px rgba(150,220,255,0.8); margin-bottom: 30px; }
        
        /* æ–‡ä»¶ä¸Šä¼ æŒ‰é’®ç¾åŒ– */
        label.upload-btn {
            background: rgba(255, 255, 255, 0.15); border: 1px solid rgba(255,255,255,0.4);
            color: #fff; padding: 15px 40px; cursor: pointer; border-radius: 50px;
            font-size: 14px; letter-spacing: 2px; transition: 0.3s;
            box-shadow: 0 0 30px rgba(50,100,255,0.3);
            text-shadow: 0 0 10px rgba(255,255,255,0.5);
        }
        label.upload-btn:hover { background: rgba(255, 255, 255, 0.3); box-shadow: 0 0 50px rgba(100,200,255,0.6); }
        input[type="file"] { display: none; }

        /* é¡¶éƒ¨å½¢çŠ¶åˆ‡æ¢æ  */
        #shape-controls {
            position: absolute; top: 20px; left: 50%; transform: translateX(-50%);
            z-index: 5; display: flex; gap: 10px;
            background: rgba(20, 20, 30, 0.5); padding: 10px 20px; border-radius: 30px;
            backdrop-filter: blur(8px); opacity: 0; transition: opacity 1s; pointer-events: none;
            border: 1px solid rgba(255,255,255,0.1);
        }
        #shape-controls.visible { opacity: 1; pointer-events: auto; }
        
        .shape-btn {
            background: transparent; border: 1px solid rgba(255,255,255,0.2); color: #aaa;
            padding: 6px 12px; cursor: pointer; border-radius: 15px; font-size: 11px; transition: 0.3s;
        }
        .shape-btn:hover { color: #fff; border-color: rgba(255,255,255,0.6); box-shadow: 0 0 15px rgba(255,255,255,0.2); }
        .shape-btn.active { background: rgba(100, 150, 255, 0.2); color: #fff; border-color: #fff; box-shadow: 0 0 20px rgba(100,150,255,0.4); }

        /* å·¦ä¸‹è§’æ’­æ”¾å™¨ */
        #player-ui {
            position: absolute; bottom: 30px; left: 30px; width: 350px;
            background: rgba(30, 30, 45, 0.5);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.15);
            border-radius: 20px;
            padding: 20px;
            z-index: 5;
            display: flex; flex-direction: column; gap: 10px;
            opacity: 0; transition: opacity 1s; transform: translateY(20px);
            box-shadow: 0 20px 50px rgba(0,0,0,0.6);
        }
        #player-ui.visible { opacity: 1; transform: translateY(0); }

        .track-info { display: flex; justify-content: space-between; align-items: center; color: #fff; font-size: 12px; margin-bottom: 5px; text-shadow: 0 0 10px rgba(255,255,255,0.3);}
        .time-display { font-family: monospace; color: #ccc; }
        
        .controls-row { display: flex; align-items: center; gap: 15px; }
        
        #play-pause-btn {
            width: 40px; height: 40px; border-radius: 50%; border: 1px solid rgba(255,255,255,0.3);
            background: rgba(255,255,255,0.1); color: #fff; cursor: pointer;
            display: flex; justify-content: center; align-items: center; font-size: 16px; transition: 0.2s;
            box-shadow: 0 0 15px rgba(255,255,255,0.1);
        }
        #play-pause-btn:hover { background: rgba(255,255,255,0.3); transform: scale(1.1); box-shadow: 0 0 25px rgba(255,255,255,0.4); }

        /* è¿›åº¦æ¡æ ·å¼ */
        input[type=range] {
            -webkit-appearance: none; width: 100%; background: transparent; cursor: pointer;
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%; height: 4px; background: rgba(255,255,255,0.15); border-radius: 2px;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; height: 12px; width: 12px; border-radius: 50%;
            background: #fff; margin-top: -4px; box-shadow: 0 0 15px rgba(255,255,255,0.9);
        }
        
    </style>
</head>
<body>

    <div id="overlay">
        <h1>COSMIC LUMINESCENCE</h1>
        <label class="upload-btn" for="musicUpload">ğŸ“‚ å¼€å¯æ˜Ÿé™…ä¹‹æ—… (MP3/FLAC)</label>
        <input type="file" id="musicUpload" accept="audio/*">
    </div>

    <div id="shape-controls">
        <button class="shape-btn active" onclick="switchShape('galaxy')">æ˜Ÿç³»</button>
        <button class="shape-btn" onclick="switchShape('sphere')">é»‘æ´</button>
        <button class="shape-btn" onclick="switchShape('heart')">å¿ƒè·³</button>
        <button class="shape-btn" onclick="switchShape('lorenz')">æ··æ²Œ</button>
        <button class="shape-btn" onclick="switchShape('mobius')">è«æ¯”ä¹Œæ–¯</button>
        <button class="shape-btn" onclick="switchShape('mandala')">æ›¼é™€ç½—</button>
    </div>

    <div id="player-ui">
        <div class="track-info">
            <span style="font-weight: 500; letter-spacing: 1px;">ULTRA LUMINOUS ENGINE</span>
            <span class="time-display" id="time-display">0:00 / 0:00</span>
        </div>
        <input type="range" id="progress-bar" value="0" step="0.1">
        <div class="controls-row">
            <button id="play-pause-btn">âšâš</button>
            <span style="font-size: 10px; color: #888;">HDR BLOOM & PHYSICS ACTIVE</span>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://unpkg.com/three@0.128.0/examples/js/postprocessing/EffectComposer.js"></script>
    <script src="https://unpkg.com/three@0.128.0/examples/js/postprocessing/RenderPass.js"></script>
    <script src="https://unpkg.com/three@0.128.0/examples/js/postprocessing/ShaderPass.js"></script>
    <script src="https://unpkg.com/three@0.128.0/examples/js/shaders/CopyShader.js"></script>
    <script src="https://unpkg.com/three@0.128.0/examples/js/shaders/LuminosityHighPassShader.js"></script>
    <script src="https://unpkg.com/three@0.128.0/examples/js/postprocessing/UnrealBloomPass.js"></script>

    <script>
        // --- æ ¸å¿ƒé…ç½® ---
        const PARTICLE_COUNT = 45000; 
        let camera, scene, renderer, composer;
        let particles, geometry;
        let analyser, dataArray, audioContext, audioEl;
        let currentShape = 'galaxy';
        let isPlaying = false;
        
        const shapes = {};
        const targets = {
            sphere: [], galaxy: [], heart: [], lorenz: [], mobius: [], mandala: []
        };
        const rand = (min, max) => Math.random() * (max - min) + min;

        const playBtn = document.getElementById('play-pause-btn');
        const progressBar = document.getElementById('progress-bar');
        const timeDisplay = document.getElementById('time-display');

        init();
        animate();

        function init() {
            scene = new THREE.Scene();
            // [ä¿®æ”¹ç‚¹1] é›¾æ°”æ›´æ·±ï¼Œå¢å¼ºå¯¹æ¯”åº¦
            scene.fog = new THREE.FogExp2(0x020205, 0.0025);

            camera = new THREE.PerspectiveCamera(55, window.innerWidth / window.innerHeight, 1, 5000);
            camera.position.z = 450;

            renderer = new THREE.WebGLRenderer({ antialias: false, powerPreference: "high-performance" });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            // [ä¿®æ”¹ç‚¹2] ä½¿ç”¨ ACESFilmicToneMapping ä»¥è·å¾—ç”µå½±çº§çš„HDRæ•ˆæœ
            renderer.toneMapping = THREE.ACESFilmicToneMapping;
            // [ä¿®æ”¹ç‚¹3] æé«˜æ•´ä½“æ›å…‰åº¦ï¼Œè®©ç”»é¢æ›´äº®
            renderer.toneMappingExposure = 1.6; 
            document.body.appendChild(renderer.domElement);

            // --- åæœŸå¤„ç†æ ¸å¿ƒè°ƒæ•´ ---
            const renderScene = new THREE.RenderPass(scene, camera);
            const bloomPass = new THREE.UnrealBloomPass(new THREE.Vector2(window.innerWidth, window.innerHeight), 1.5, 0.4, 0.85);
            
            // [å…³é”®ä¿®æ”¹ç‚¹4ï¼šè¾‰å…‰å‚æ•°]
            // threshold (é˜ˆå€¼) é™åˆ° 0ï¼šè®©æ‰€æœ‰ç²’å­ï¼Œæ— è®ºå¤šæš—ï¼Œéƒ½å‚ä¸è¾‰å…‰è®¡ç®—ï¼Œå¢åŠ å®‡å®™è‡´å¯†æ„Ÿã€‚
            bloomPass.threshold = 0; 
            // strength (å¼ºåº¦) æé«˜ï¼šåŸºç¡€è¾‰å…‰æ›´å¼ºã€‚
            bloomPass.strength = 2.2; 
            // radius (åŠå¾„) å¢å¤§ï¼šå…‰æ™•æ‰©æ•£å¾—æ›´è¿œï¼Œæ›´æœ¦èƒ§ã€‚
            bloomPass.radius = 0.85;

            composer = new THREE.EffectComposer(renderer);
            composer.addPass(renderScene);
            composer.addPass(bloomPass);

            generateParticles();
            calculateShapes();

            window.addEventListener('resize', onWindowResize);
            document.getElementById('musicUpload').addEventListener('change', handleAudioUpload);
            
            playBtn.addEventListener('click', togglePlay);
            progressBar.addEventListener('input', () => {
                if(audioEl) {
                    audioEl.currentTime = (progressBar.value / 100) * audioEl.duration;
                }
            });
        }

        function generateParticles() {
            geometry = new THREE.BufferGeometry();
            const positions = new Float32Array(PARTICLE_COUNT * 3);
            const colors = new Float32Array(PARTICLE_COUNT * 3);
            const sizes = new Float32Array(PARTICLE_COUNT);

            const colorObj = new THREE.Color();

            for (let i = 0; i < PARTICLE_COUNT; i++) {
                const i3 = i * 3;
                positions[i3] = rand(-1000, 1000);
                positions[i3+1] = rand(-1000, 1000);
                positions[i3+2] = rand(-1000, 1000);

                // åˆå§‹é¢œè‰²ï¼šæ›´é«˜é¥±å’Œåº¦å’Œäº®åº¦
                let hue = Math.random() > 0.6 ? 0.6 : 0.68; // åè“ç´«
                colorObj.setHSL(hue, 0.9, 0.7); 
                colors[i3] = colorObj.r;
                colors[i3+1] = colorObj.g;
                colors[i3+2] = colorObj.b;
                
                // [ä¿®æ”¹ç‚¹5] ç²’å­æ•´ä½“å˜å¤§ä¸€ç‚¹ï¼Œå¢åŠ å…‰æºé¢ç§¯
                sizes[i] = rand(1.0, 3.5); 
            }

            geometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
            geometry.setAttribute('color', new THREE.BufferAttribute(colors, 3));
            geometry.setAttribute('size', new THREE.BufferAttribute(sizes, 1));

            const material = new THREE.PointsMaterial({
                // [ä¿®æ”¹ç‚¹6] æè´¨åŸºç¡€å¤§å°å¢åŠ 
                size: 2.5,
                vertexColors: true,
                // ä½¿ç”¨ä¸€ä¸ªä¸­å¿ƒæäº®ï¼Œè¾¹ç¼˜æŸ”å’Œçš„çº¹ç†
                map: new THREE.TextureLoader().load('https://threejs.org/examples/textures/sprites/spark1.png'),
                blending: THREE.AdditiveBlending, // å…³é”®ï¼šå‘å…‰å åŠ æ¨¡å¼
                depthWrite: false,
                transparent: true,
                // [ä¿®æ”¹ç‚¹7] ä¸é€æ˜åº¦æ‹‰æ»¡
                opacity: 1.0 
            });

            particles = new THREE.Points(geometry, material);
            scene.add(particles);
        }

        // --- é¢„è®¡ç®—å½¢çŠ¶ (ä¿æŒä¸å˜) ---
        function calculateShapes() {
            // Galaxy
            for (let i = 0; i < PARTICLE_COUNT; i++) {
                const angle = i * 0.05;
                const r = i * 0.015;
                targets.galaxy.push(
                    Math.cos(angle) * r * 9 + rand(-15, 15),
                    Math.sin(angle) * r * 9 + rand(-15, 15),
                    (Math.random()-0.5) * (150 - r) * 1.5
                );
            }
            // Sphere
            for (let i = 0; i < PARTICLE_COUNT; i++) {
                const phi = Math.acos(-1 + (2 * i) / PARTICLE_COUNT);
                const theta = Math.sqrt(PARTICLE_COUNT * Math.PI) * phi;
                const r = 220;
                targets.sphere.push(
                    r * Math.cos(theta) * Math.sin(phi),
                    r * Math.sin(theta) * Math.sin(phi),
                    r * Math.cos(phi)
                );
            }
            // Heart
            for (let i = 0; i < PARTICLE_COUNT; i++) {
                 let t = rand(0, Math.PI * 2); 
                 let scale = 12;
                 let x = 16 * Math.pow(Math.sin(t), 3);
                 let y = 13 * Math.cos(t) - 5 * Math.cos(2*t) - 2 * Math.cos(3*t) - Math.cos(4*t);
                 let z = rand(-5, 5) * (x * 0.1 + 2);
                 targets.heart.push(x * scale, y * scale, z * scale);
            }
            // Lorenz
            let x = 0.1, y = 0, z = 0;
            let dt = 0.0055;
            let sigma = 10, rho = 28, beta = 8/3;
            for (let i = 0; i < PARTICLE_COUNT; i++) {
                let dx = sigma * (y - x) * dt;
                let dy = (x * (rho - z) - y) * dt;
                let dz = (x * y - beta * z) * dt;
                x += dx; y += dy; z += dz;
                targets.lorenz.push(x * 5.5, y * 5.5, (z - 25) * 5.5);
            }
            // Mobius
            for (let i = 0; i < PARTICLE_COUNT; i++) {
                let u = rand(0, Math.PI * 2);
                let v = rand(-1, 1);
                let radius = 150;
                let width = 75;
                targets.mobius.push(
                    (radius + v * width/2 * Math.cos(u/2)) * Math.cos(u),
                    (radius + v * width/2 * Math.cos(u/2)) * Math.sin(u),
                    v * width/2 * Math.sin(u/2)
                );
            }
            // Mandala
            for (let i = 0; i < PARTICLE_COUNT; i++) {
                let r = rand(10, 240);
                let theta = rand(0, Math.PI * 2);
                let petals = 8; 
                let distortion = Math.sin(theta * petals) * 45;
                targets.mandala.push(
                    (r + distortion) * Math.cos(theta),
                    (r + distortion) * Math.sin(theta),
                    Math.sin(r * 0.15) * 35
                );
            }
        }

        // --- éŸ³é¢‘å¤„ç† ---
        function handleAudioUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            if (audioEl) audioEl.pause();
            if (audioContext) audioContext.close();

            audioEl = document.createElement('audio');
            audioEl.src = URL.createObjectURL(file);
            audioEl.loop = false;
            
            audioEl.addEventListener('canplay', () => {
                if(!audioContext) {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    const src = audioContext.createMediaElementSource(audioEl);
                    analyser = audioContext.createAnalyser();
                    analyser.fftSize = 2048;
                    analyser.smoothingTimeConstant = 0.8;
                    src.connect(analyser);
                    analyser.connect(audioContext.destination);
                    dataArray = new Uint8Array(analyser.frequencyBinCount);
                }
                playMusic();
            });

            audioEl.addEventListener('timeupdate', updateProgress);
            audioEl.addEventListener('ended', () => {
                isPlaying = false;
                playBtn.innerHTML = 'â–º';
            });

            document.getElementById('overlay').style.opacity = 0;
            setTimeout(() => {
                document.getElementById('overlay').style.display = 'none';
                document.getElementById('shape-controls').classList.add('visible');
                document.getElementById('player-ui').classList.add('visible');
            }, 1000);
        }

        function playMusic() {
            audioContext.resume().then(() => {
                audioEl.play();
                isPlaying = true;
                playBtn.innerHTML = 'âšâš';
            });
        }

        function togglePlay() {
            if (!audioEl) return;
            if (isPlaying) {
                audioEl.pause();
                playBtn.innerHTML = 'â–º';
            } else {
                audioEl.play();
                playBtn.innerHTML = 'âšâš';
            }
            isPlaying = !isPlaying;
        }

        function updateProgress() {
            const current = audioEl.currentTime;
            const duration = audioEl.duration;
            if (duration) {
                progressBar.value = (current / duration) * 100;
                timeDisplay.textContent = formatTime(current) + ' / ' + formatTime(duration);
            }
        }

        function formatTime(s) {
            const m = Math.floor(s / 60);
            const sec = Math.floor(s % 60);
            return `${m}:${sec < 10 ? '0' : ''}${sec}`;
        }

        window.switchShape = function(name) {
            currentShape = name;
            document.querySelectorAll('.shape-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
        };

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
            composer.setSize(window.innerWidth, window.innerHeight);
        }

        function animate() {
            requestAnimationFrame(animate);

            let bass = 0, mid = 0, high = 0;
            let avgVolume = 0;

            if (analyser && isPlaying) {
                analyser.getByteFrequencyData(dataArray);
                let bSum = 0, mSum = 0, hSum = 0;
                for(let i=0; i<40; i++) bSum += dataArray[i];
                for(let i=40; i<200; i++) mSum += dataArray[i];
                for(let i=200; i<800; i++) hSum += dataArray[i];
                bass = bSum / 40;
                mid = mSum / 160;
                high = hSum / 600;
                avgVolume = (bass + mid + high) / 3;
            } else {
                avgVolume = 15 + Math.sin(Date.now() * 0.002) * 15;
            }

            const positions = geometry.attributes.position.array;
            const colors = geometry.attributes.color.array;
            const targetPos = targets[currentShape];
            
            let scatter = 0;
            if (bass > 155) {
                scatter = (bass - 155) * 0.9; 
            }
            const pulse = 1 + (avgVolume / 255) * 0.35;

            // [å…³é”®ä¿®æ”¹ç‚¹8ï¼šåŠ¨æ€HDRé¢œè‰²è®¡ç®—]
            // è®©åŸºç¡€äº®åº¦å°±å¾ˆé«˜ï¼Œå¹¶ä¸”å…è®¸éŸ³ä¹å°†å…¶æ¨å‘æå¤§å€¼ï¼ˆè¶…è¿‡1.0ï¼‰
            // è¿™é‡Œçš„ baseBrightness åœ¨éŸ³ä¹é«˜æ½®æ—¶å¯ä»¥è¾¾åˆ° 3.0 ä»¥ä¸Š
            let baseBrightness = 0.8 + (bass / 255) * 2.5; 

            for (let i = 0; i < PARTICLE_COUNT; i++) {
                const i3 = i * 3;
                
                let tx = targetPos[i3] * pulse;
                let ty = targetPos[i3+1] * pulse;
                let tz = targetPos[i3+2] * pulse;

                if (scatter > 0) {
                    tx += (Math.random() - 0.5) * scatter * 12;
                    ty += (Math.random() - 0.5) * scatter * 12;
                    tz += (Math.random() - 0.5) * scatter * 12;
                }

                const speed = 0.04 + (mid / 255) * 0.12;
                positions[i3] += (tx - positions[i3]) * speed;
                positions[i3+1] += (ty - positions[i3+1]) * speed;
                positions[i3+2] += (tz - positions[i3+2]) * speed;

                // åº”ç”¨HDRé¢œè‰²
                // Ré€šé“å—é«˜éŸ³å½±å“å˜ç™½ï¼ŒBé€šé“å—ä½éŸ³å½±å“å˜æ·±è“
                // å…³é”®æ˜¯è¿™äº›å€¼ç°åœ¨å¯ä»¥è¿œè¿œå¤§äº 1.0ï¼Œä»è€Œè§¦å‘å¼ºçƒˆçš„è¾‰å…‰
                colors[i3]   = baseBrightness * (1.0 + high/200); // R
                colors[i3+1] = baseBrightness * (0.7 + high/400); // G
                colors[i3+2] = baseBrightness * (1.3 + bass/400); // B
            }

            geometry.attributes.position.needsUpdate = true;
            geometry.attributes.color.needsUpdate = true;

            particles.rotation.y += 0.0015 + (avgVolume * 0.00006);
            
            // [ä¿®æ”¹ç‚¹9] è¾‰å…‰å¼ºåº¦éšéŸ³ä¹åŠ¨æ€å˜åŒ–çš„å¹…åº¦ä¹Ÿå¢åŠ äº†
            composer.passes[1].strength = 2.2 + (bass / 255) * 2.5;

            composer.render();
        }
    </script>
</body>
</html>
